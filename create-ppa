#!/bin/bash

set -e

# Check for appropriate number of arguments
if [[ $# -ne 1 ]]; then
    echo Usage: create-ppa version
    exit 1
fi

# First argument is version (remove any hyphens)
version=${1//-/}

# Step 1 -- get OpenMC source and create an archive given the tag
if [[ ! -e openmc_${version}.orig.tar.gz ]]; then
    git clone --recursive git@github.com:mit-crpg/openmc.git
    cd openmc
    ../git-archive-all.sh --prefix openmc-${version}/ -t v${version} ../openmc_${version}.orig.tar
    cd ..
    gzip -n openmc_${version}.orig.tar
    rm -rf openmc
fi

# Step 2 -- Extract created archive and copy debian files
tar xvf openmc_${version}.orig.tar.gz
cd openmc-${version}
cp -R ../debian-files debian

# Step 3 -- Edit changelog
dch -v ${version}-0ppa1 --package openmc \
    -D $(lsb_release -c | awk '{print $2}')
cp debian/changelog ../debian-files/

# Step 4 -- Build the Debian package
debuild -S -sa
cd ..

# Step 5 -- Upload to launchpad
echo -e "Now run \e[34mdput ppa:paulromano/staging openmc_${version}-0ppa1_source.changes\e[0m"
